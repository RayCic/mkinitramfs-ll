#!/bin/zsh
# $Id: mkinitramfs-ll/mkifs-ll_gpg[.zsh],v 0.4.1 2011/12/04 -tclover Exp $

usage() {
   cat <<-EOF
   usage: ${(%):-%1x} [-U|-useflag'falgs'] [-V|-Version'<str>'] [OPTIONS]
   -B|-bindir bin       copy builded binary to <bin> directory
   -M|-miscdir misc     use msc dir for {.gnupg/gpg.conf,share/gnupg/options.skel} files,
                        one can add manpages gpg/lvm/cryptsetup and user scripts as well
   -W|-wokdir dir       working directory where to create initramfs dir, default is PWD
   -U|-useflag'flags'   extra USE flags to append to USE="nls static"
   -V|-Version'<str>'   build gpg-<str> version instead of gpg-1.4.x
   -u|-usage            print this help/uage and exit
EOF
}

error() { print -P "%B%F{red}*%b%f $@"; }
die()   { error $@; exit 1; }
alias die='die "%F{yellow}%1x:%U${(%):-%I}%u:%f" $@'

if [[ $# = 0 ]] { typeset -A opts; info "building GnuPG..."
} else {
	zmodload zsh/zutil
	zparseopts -E -D -K -A opts U:: useflag:: V:: Version:: \
		B:: bindir:: M:: miscdir:: u usage W:: workdir::
	if [[ $# != 0 ]] || [[ -n ${(k)opts[-u]} ]] || [[ -n ${(k)opts[-usage]} ]] {
		usage; exit 0 }
}
:	${opts[-workdir]:=${opts[-W]:-$(pwd)}}
:	${opts[-bindir]:=${opts[-B]:-$opts[-workdir]/bin}}
:	${opts[-bindir]:=${opts[-M]:-$opts[-workdir]/misc}}
mkdir -p $opts[-workdir]
mkdir -p $opts[-bindir]
mkdir -p $opts[-miscdir]/share/gnupg

cd ${PORTDIR:-/usr/portage}/app-crypt/gnupg || die "eek"
GPG=$(emerge -pvO =app-crypt/gnupg-${opts[-Version]:-${opts[-V]:-1.4*}} | \
	  grep -o "gnupg-[-0-9.r]*")
USE="nls static ${=opts[-useflag]:-$opts[-U]}" ebuild $GPG.ebuild compile || die "eek!"
cd ${PORTAGE_TMPDIR:-/var/tmp}/portage/app-crypt/$GPG/work/$GPG || die "eek!"
cp -a gpg ${opts[-bindir]}/ || die "eek!"
cp g10/options.skel ${opts[-miscdir]}/share/gnupg/ || die "eek!"
cd ${PORTDIR:-/usr/portage}/app-crypt/gnupg || die "eek"
ebuild $GPG.ebuild clean || die "eek!"
cd $opts[-worddir] || die "eek!"

opts[-gpg]=

# vim:fenc=utf-8:ci:pi:sts=0:sw=4:ts=4:
