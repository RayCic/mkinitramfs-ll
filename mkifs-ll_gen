#!/bin/zsh
# $Id: mkinitramfs-ll/mkifs-ll_gen[.zsh],v 0.4.1 2011/12/04 -tclover Exp $

usage() {
  cat <<-EOF
  usage: ${(%):-%1x} [OPTIONS] [OPTIONS...]
  -a|-all              short forme/hand of '-sqfsd -lvm -gpg -toi'
  -D|-build	           build a static busybox and GnuPG-1.x binaries
  -f|-font :<font>     append collon seperated list of fonts to in include
  -e|-ev d             append an extra 'd' version after \$kv to the initramfs image
  -k|-kv 3.1.4-git     build an initramfs for '3.1.4-git' kernel, else for \$(uname -r)
  -c|-comp             compression command to use to build initramfs, default is 'xz -9..'
  -g|-gpg              adds GnuPG support, require a static gnupg-1.4.x and 'options.skel'
  -p|-prefix vmlinuz.  prefix scheme to name the initramfs image default is 'initrd-'
  -y|-keymap kmx86.bin append collon seperated list of keymaps to include in the initramfs
  -l|-lvm              adds LVM2 support, require a static sys-fs/lvm2[lvm.static] binary
  -B|-bindir bin       try to include binaries from bin dir (busybox/applets/gpg) first
  -M|-miscdir misc     use msc dir for {.gnupg/gpg.conf,share/gnupg/options.skel} files,
                       one can add manpages gpg/lvm/cryptsetup and user scripts as well
  -W|-wokdir dir       working directory where to create initramfs dir, default is PWD
  -b|-bin :<bin>       append collon seperated list of binar-y-ies to include
  -C|-confdir dir      copy gpg.conf, GnuPG configuration file, from dir
  -m|-modep :<mod>     collon seperated list of kernel module-s to include
  -S|-splash :<theme>  collon ':' separated list of splash themes to include
     -mgpg :<mod>      collon seperated list of kernel modules to add to gpg group
     -mboot :<mod>     collon seperated list of kernel modules to add to boot group
     -msqfsd :<mod>    collon seperated list of kernel modules to add to sqfsd group
     -mremdev :<mod>   collon seperated list of kernel modules to add to remdev group
     -mtuxonice :<mod> collon seperated list of kernel modules to add to tuxonice group
  -t|-toi              adds tuxonice support for splash, require tuxoniceui_text binary
  -s|-sqfsd            add aufs(+squashfs modules +{,u}mount.aufs binaries) support
  -i|-install	       install busybox with symliks to \$opts[-bindir], require -b
  -n|-minimal	       build busybox with minimal applets, default is full applets
  -U|-ucl-arch i386    ARCH string needed to build busybox linked uClibc
  -Y|-key-map <k:m>    generate <m> keymap using <k> as input keymap
  -u|-usage            print this help/usage and exit
  -v|-version          print version string and exit

  usage: runned without arguments, build an initramfs for kernel \$(uname -r)
  # build an initramfs after building gnupg/busybox (AUFS2/LVM2/GPG support)
  ${(%):-%1x} -build -sqfsd -lvm
EOF
}

error() { print -P "%B%F{red}*%b%f $@"; }
die()   { error $@; exit 1; }
alias die='die "%F{yellow}%1x:%U${(%):-%I}%u:%f" $@'

if [[ $# = 0 ]] { if [[ -z ${(k)opts[*]} ]] { typeset -A opts }
	info "initramfs will be build with only LUKS support."
} else {
	zmodload zsh/zutil
	zparseopts -E -D -K -A opts a all s sqfsd g gpg l lvm t toi c:: comp:: \
		e:: ev:: k:: kv:: m+:: modep+:: f+:: font+:: M:: miscdir \
		S:: splash:: u usage v version W:: workdir::  b:: bin:: p:: prefix:: \
		y:: keymap:: B:: bindir:: mboot+:: mgpg+:: msqfsd+:: mtuxonice+:: \
		D build i install n minimal Y: key-map: U: ucl-arch:
	if [[ $# != 0 ]] || [[ -n ${(k)opts[-u]} ]] || [[ -n ${(k)opts[-usage]} ]] {
		usage; exit 0 }
}
:	${opts[-workdir]:=${opts[-W]:-$(pwd)}}
:	${opts[-miscdir]:=${opts[-M]:-$opts[-workdir]/misc}}
:	${opts[-bindir]:=${opts[-B]:-$opts[-workdir]/bin}}
[[ -f ./mkifs-ll.conf ]] && source ./mkifs-ll.conf
mkdir -p $opts[-workdir]
mkdir -p $opts[-bindir]

if [[ -n ${(k}opts[-build]} ]] || [[ -n ${(k)opts[-D]} ]] { ./mkifs-ll_bb
	if [[ -n ${(k}opts[-gpg]} ]] || [[ -n ${(k)opts[-g]} ]] { ./mkifs-ll_gpg
		if [[ -d $opts[-confdir] ]] || [[ -d ${opts[-C]} ]] { 
			mkdir -p $opts[-miscdir]/.gnupg/
			cp $opts[-confdir]/gpg.conf $opts[-miscdir]/.gnupg/ || die "eek!"
		}
}

./mkifs-ll

# vim:fenc=utf-8:ci:pi:sts=0:sw=4:ts=4:
